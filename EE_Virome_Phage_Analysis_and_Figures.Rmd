---
title: "Environmental Enteropathy: Phage Analysis and Figures"
author: "Chandani Desai & Rachel Rodgers"
date: "August 05, 2019"
output: html_document
---

# Phage Analyses for Stunting and Environmental Enteropathy

```{r initiate-environment, include=FALSE}
# Global knitr option
knitr::opts_chunk$set(fig.width=8,
                      fig.height=6,
                      warning=FALSE,
                      message=FALSE)

# Load libraries
library("phyloseq")
library("RColorBrewer")
library("vegan")
library("gridExtra")
library("knitr")
library("plotly")
library("ggpubr")
library("data.table")
library("microbiome")
library("DESeq2")
library("ggrepel")
library("pheatmap")
library("FSA")
library("gmodels")
library("tidyverse")

source("./shared_R_scripts/Helper_Functions.R")

# Load Viral Pre-processing Data

load("./data/RDataObjects/EE_Virome_Preprocessing.RData")
physeqVirusFinal # 3035 x 145 (contains all taxa and healthy + EE samples)
physeqSubsetFinal # 1021 x 145 (contains selected phage and healthy + EE samples)
```

## Sample Selection - Growth_Status_Prior, Moderate & Severe EE

Now we will select samples with Adequate, Moderate, or Poor growth based on Growth_Status_Prior.  We will be selecting these samples from physeqSubsetFinal (which contains just the phage taxa of interest).  We are also removing samples that were considered healthy (not having EE) as based on the percent L measurement.

```{r physeqPriorAllEE}
# This also includes "healthy" samples.
levels(sample_data(physeqSubsetFinal)$Growth_Status_Prior)
table(sample_data(physeqSubsetFinal)$Growth_Status_Prior)
# Adequate = 37, Moderate = 42, Poor = 14 (total of 93 samples)

physeqPrior <- physeqSubsetFinal %>% 
  subset_samples(Growth_Status_Prior %in% c("Adequate", "Moderate", "Poor")) %>% 
  RemoveMissingTaxa()
physeqPrior # 1006 x 93

table(sample_data(physeqPrior)$EE_status_based_on_percL)
# No = 6, Moderate = 43, Severe = 44 (87 samples have EE)

physeqPriorAllEEPhage <- physeqPrior %>% 
  subset_samples(EE_status_based_on_percL != "No") %>% 
  RemoveMissingTaxa()
physeqPriorAllEEPhage # 998 x 87
```

## Phage Community Composition by Growth Status Prior

```{r phage-community-composition}
phageAbundanceDF <- MakeAbundanceDF(physeqPriorAllEEPhage,
                                    taxRank = "Rank1", abundanceFilter = 0.01)
phageAbundanceDF$Rank1 <- as.character(phageAbundanceDF$Rank1)

phageAbundanceDF <- phageAbundanceDF %>% 
  mutate("Taxon" = ifelse(Rank0 == "other_phages",
                          yes = "other phages", no = Rank1))

phageLevels <- unique(phageAbundanceDF$Taxon)
phageLevels <- phageLevels[phageLevels != "other phages"]
phageLevelsArranged <- phageLevels[order(phageLevels)]
phageLevelsArranged <- c(phageLevelsArranged, "other phages")

phageAbundanceDF$Taxon <- factor(phageAbundanceDF$Taxon,
                                 levels = phageLevelsArranged)

phageCommComp <- ggplot(phageAbundanceDF,
                        aes(x = sample_name, y = Abundance, fill = Taxon)) +
  geom_bar(stat = "identity", width = 1, position = "fill") +
  labs(y = "Relative Abundance") +
  facet_wrap(~ Growth_Status_Prior, scales = "free_x") +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 12),
        strip.text = element_text(size = 10),
        legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 10),
        legend.box.margin = margin(-10, -10, -10, -10),
        legend.key.size = unit(0.5, "cm")) +
  scale_fill_brewer(palette = "Set1")
phageCommComp 
```

### Phage Alpha and Beta Diversity Plots

```{r CalculateAlphaDiversity}
CalculateAlphaDiversity <- function(physeqObj) {
  alphaDivDF <- estimate_richness(physeqObj,
                                  measures = c("Observed", "Shannon"))
  # Change periods in alphaDivDF back to hyphens so we can merge w/sample data
  row.names(alphaDivDF) <- c(gsub("\\.", "-", rownames(alphaDivDF)))
  
  sampleDataDF <- as(sample_data(physeqObj), "data.frame")
  
  alphaDivDF <- merge(alphaDivDF, sampleDataDF, by = "row.names")
  return(alphaDivDF)
}
```

```{r alphaDivDFList}
phageAlphaDiv <- CalculateAlphaDiversity(physeqPriorAllEEPhage)
```

```{r phageRichnessByGrowth}
phageRichnessByGrowth <- ggplot(phageAlphaDiv,
                                aes(x = Growth_Status_Prior, y = Observed)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(alpha = 0.7, width = 0.15, size = 1.5) +
  ylab("Richness") +
  stat_compare_means(label = "p.format", method = "kruskal.test", 
                     hide.ns = TRUE, label.x.npc = 0.5,
                     size = 3.5) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.y = element_text(size = 10))
set.seed(2908795)
phageRichnessByGrowth
```

```{r phageDiversityByGrowth}
phageDiversityByGrowth <- ggplot(phageAlphaDiv, 
                              aes(x = Growth_Status_Prior, y = Shannon)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(alpha = 0.7, width = 0.15, size = 1.5) +
  ylab("Shannon Diversity") +
  stat_compare_means(label = "p.format", method = "kruskal.test", 
                     hide.ns = TRUE, label.x.npc = 0.5, label.y.npc = 0.07,
                     size = 3.5) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.y = element_text(size = 10))

set.seed(2908795)
phageDiversityByGrowth
```

#### Dunn's Post-Hoc Test on Diversity

```{r dunns-post-hoc-phage-diversity}
GetAbdValues <- function(myDF, growthCategory, valueCol) {
  myDF %>%  
    filter(Growth_Status_Prior == growthCategory) %>%
    select(Growth_Status_Prior, valueCol)
}

growthCategories <- c("Adequate", "Moderate", "Poor")

phageDivValuesList <- map(growthCategories,
                          ~ GetAbdValues(myDF = phageAlphaDiv, 
                                         growthCategory = .x,
                                         valueCol = "Shannon"))

phageDivDunnDF <- Reduce(f = function(df1, df2) {rbind(x = df1, y = df2)},
                         x = phageDivValuesList)

phageDunnTest <- dunnTest(Shannon ~ Growth_Status_Prior, phageDivDunnDF)
phageDunnTest$res
```

adequate - moderate p-adj = 0.006

### Phage MDS of Bray Distances

```{r mdsBrayPhage}
set.seed(40072100)
RunAdonis(physeqPriorAllEEPhage, distance = "bray", 
          category = "Growth_Status_Prior")

set.seed(40072100)
ordBrayPhage <- phyloseq::ordinate(physeq = physeqPriorAllEEPhage,
                                   method = "MDS", distance = "bray")
class(ordBrayPhage)
eigenValues <- ordBrayPhage$values$Relative_eig

mdsBrayPhageDF <- plot_ordination(physeqPriorAllEEPhage, ordBrayPhage,
                                  justDF = TRUE)

mdsBrayPhage <- ggplot(mdsBrayPhageDF, 
                       aes_string(x = "Axis.1", y = "Axis.2",
                                  color = "Growth_Status_Prior")) +
  xlab(paste0("MDS 1 (", round(100*eigenValues[1], digits = 1), "%)")) +
  ylab(paste0("MDS 2 (", round(100*eigenValues[2], digits = 1), "%)")) +
  geom_point(size=2, alpha = 0.7) +
  annotate("text", x = -0.35, y = 0.22, label = "p = 0.025", size = 3.5) +
  scale_color_manual(values = c("red", "blue", "green")) +
  theme(legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 10),
        legend.box.margin = margin(-10, -10, -10, -10),
        axis.title = element_text(size = 10))
mdsBrayPhage
```

### Arrang Phage Panel

```{r, fig.width=7.5, fig.height=7}
phagePanel <- ggarrange(phageCommComp,
                        ggarrange(phageRichnessByGrowth, 
                                  phageDiversityByGrowth, 
                                  mdsBrayPhage,
                                  labels = c("B", "C", "D"),
                                  ncol = 3,
                                  widths = c(0.2, 0.2, 0.3)),
                        nrow = 2,
                        labels = c("A"), 
                        heights = c(1.1,0.6,0.75))
phagePanel
```

Phage panel scaling

```{r phage-panel-scaling, eval=FALSE}
tiff("../figures/Figure5.tiff", 
     units = "in", width = 7.5, height = 7, res = 300)
phagePanel
dev.off()
```

### DESeq on Phage

First need to prevalence filter - remove taxa present in only one sample.

```{r phage-prevalence}
#----- prevalence filtering (taxa  present in > 1 sample) -----#
phagePrevVec <- apply(X = otu_table(physeqPriorAllEEPhage),
                      MARGIN = ifelse(taxa_are_rows(physeqPriorAllEEPhage),
                                      yes = 1, no =2),
                      FUN = function(x) {sum(x > 0)})

phageAbdVec <- taxa_sums(physeqPriorAllEEPhage)

phageTaxTable <- as(tax_table(physeqPriorAllEEPhage), "matrix")

phagePrevDF <- data.frame(Prevalence = phagePrevVec,
                          TotalAbundance = phageAbdVec,
                          phageTaxTable)

keepPhageDESeq <- phagePrevDF %>% 
  rownames_to_column(var = "taxon") %>% 
  filter(Prevalence > 1) %>% 
  pull(taxon) # 934 keepers

physeqPhageFilt <- prune_taxa(keepPhageDESeq, physeqPriorAllEEPhage)
physeqPhageFilt # 934 x 87

any(sample_sums(physeqPhageFilt) == 0) # FALSE

#----- Remove Moderate Samples -----#
physeqPhageNoModerate <- physeqPhageFilt %>% 
  subset_samples(Growth_Status_Prior != "Moderate") %>% 
  RemoveMissingTaxa()
physeqPhageNoModerate # 915 x 47

#----- How Many Samples in Each Growth Category? -----#
sampleDataPhageDESeq <- as(sample_data(physeqPhageNoModerate), "data.frame")
sampleDataPhageDESeq %>% 
  group_by(Growth_Status_Prior) %>% 
  summarize(count = n())

#----- DESeq2 Analysis -----#
ddsPhage <- phyloseq_to_deseq2(physeqPhageNoModerate,
                               design = ~ bf_at_sampling + Growth_Status_Prior)
set.seed(47544091)
ddsPhageAnalysis <- DESeq(ddsPhage, test = "Wald", fitType = "local", betaPrior = FALSE)
ddsPhageResults <- results(ddsPhageAnalysis,
                           contrast = c(variable = "Growth_Status_Prior",
                                        numerator = "Poor",
                                        denominator = "Adequate"))
deseqPhageResultsTable <- GenerateDESeqResultsTable(physeq = physeqPhageNoModerate,
                                                    ddsResults = ddsPhageResults)

phageVolcano <- ggplot(deseqPhageResultsTable,
                  aes(x = log2FoldChange,
                      y = -log10(padj),
                      label1 = Rank1,
                      label2 = Rank2,
                      label3 = Rank3)) +
    geom_point(data = subset(deseqPhageResultsTable,
                             deseqPhageResultsTable$Significant == FALSE),
               color = "grey") +
    geom_point(data = subset(deseqPhageResultsTable,
                             deseqPhageResultsTable$Significant == TRUE),
               aes(color = Rank1, size = baseMean)) +
    geom_vline(xintercept = 0, lty = 2) +
    geom_hline(yintercept = -log10(0.05)) +
    ggtitle("Phage DESeq2 Results Adequate vs Poor Growth Status") +
    theme_bw() +
    theme(plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5),
          axis.title = element_text(size = 12),
          axis.text = element_text(size = 12),
          legend.text = element_text(size = 12))
phageVolcano
```

```{r phage-deseq-results-plot, fig.width=7.5, fig.height=6}
phageSigASVDF <- deseqPhageResultsTable %>% 
  filter(Significant == TRUE)

# how many significant taxa were identified?
length(unique(phageSigASVDF$OTU)) # 18

phageSigASVDFModified <- phageSigASVDF %>% 
  mutate("TaxaName" = paste(Rank1, Rank2, Rank3, Rank4),
         "stderror_lower" = log2FoldChange - lfcSE,
         "stderror_upper" = log2FoldChange + lfcSE)

# Fix taxa names by generating a long-to-short name LUT
sigPhageNamesLong <- phageSigASVDFModified$TaxaName
sigPhageNamesShort <- c("unclassified Myoviridae",
                        "unclassified Myoviridae Xanthomonas phage vB-XveM-DIBBI",
                        "unclassified Myoviridae Bacillus phage BCD7",
                        "unclassified Myoviridae Pelagibacter phage HTVC008M",
                        "unclassified Myoviridae Microcystis phage MaMV-DC",
                        "Myoviridae Bacillus phage CP-51",
                        "unclassified Myoviridae Clostridium phage phi-MMP01",
                        "unclassified Myoviridae Enterococcus phage EFDG1",
                        "unclassified Podoviridae",
                        "Myoviridae Geobacillus phage GBSV1",
                        "unclassified Siphoviridae Lactococcus phage Q54",
                        "unclassified Siphoviridae Clostridium phage phi-SM101",
                        "unclassified Myoviridae Haemophilus phage SuMu",
                        "unclassified Siphoviridae Cyanophage PSS2",
                        "unclassified Myoviridae Psychrobacter phage pOW20-A",
                        "unclassified Siphoviridae Clostridum phage phi-CD6356",
                        "unclassified Microviridae phi-CA82",
                        "unclassified Podoviridae Planktothrix phage PaV-LD")
sigPhageNamesLUT <- sigPhageNamesShort
names(sigPhageNamesLUT) <- sigPhageNamesLong

phageSigASVDFModified <- phageSigASVDFModified %>% 
  mutate("corrected_TaxaName" = sigPhageNamesLUT[TaxaName]) %>% 
  arrange(desc(log2FoldChange))

correctedTaxaNameLevels <- phageSigASVDFModified$corrected_TaxaName
phageSigASVDFModified$corrected_TaxaName <- factor(phageSigASVDFModified$corrected_TaxaName,
                                                   levels = correctedTaxaNameLevels)

phageDESeqResultsPlotFinal <- ggplot(phageSigASVDFModified,
                                     aes(x = log2FoldChange, 
                                         y = corrected_TaxaName)) +
  geom_point(size=2) +
  geom_vline(xintercept = 0, alpha = 0.5, linetype = 2) +
  geom_errorbarh(aes(xmin = stderror_lower, xmax = stderror_upper, height=0.1)) +
  labs(x = "log2 Fold Change", y="",subtitle = "Adequate <------> Poor") +
  theme_bw() +
  theme(plot.subtitle = element_text(hjust = 0.5))
phageDESeqResultsPlotFinal
```

```{r phage-deseq-tiff, eval=FALSE}
# figure 6
tiff("../figures/Figure6.tiff", 
     units = "in", width = 7.5, height = 6, res = 300)
phageDESeqResultsPlotFinal
dev.off()
```

Ground truth plots of all differential phage taxa.

```{r fig.width=7.5, fig.height=7}
phageSigASVVec <- phageSigASVDF$OTU

sigPhageNormalizedAbdDF <- psViralNormalizedMelt %>% 
  filter(ASV %in% phageSigASVVec)

sigPhageNormalizedAbdDFModified <- sigPhageNormalizedAbdDF %>% 
  filter(Growth_Status_Prior %in% c("Adequate", "Moderate", "Poor")) %>% 
  mutate("TaxaName" = paste(Rank5, Rank6, Rank7, Rank8, sep = " "),
         "corrected_TaxaName" = sigPhageNamesLUT[TaxaName])

# which taxa didn't get named (if any)
unnamedTaxa <- sigPhageNormalizedAbdDFModified %>% 
  filter(is.na(corrected_TaxaName)) %>% 
  select(TaxaName) %>% 
  unique()

unnamedTaxa <- as.character(unnamedTaxa$TaxaName)
class(sigPhageNormalizedAbdDFModified$TaxaName)

sigPhageNormalizedAbdDFModified <- sigPhageNormalizedAbdDFModified %>% 
  mutate("corrected_TaxaName" = ifelse(is.na(corrected_TaxaName),
                                       yes = "unclassified Microviridae phi-CA82",
                                       no = corrected_TaxaName))

# apply levels to this normalized abundance df so order of facets match
#   order of taxa in the deseq results plot
sigPhageNormalizedAbdDFModified$corrected_TaxaName <- factor(sigPhageNormalizedAbdDFModified$corrected_TaxaName,
                                                             levels = rev(correctedTaxaNameLevels))

unique(sigPhageNormalizedAbdDFModified$corrected_TaxaName)

groundTruthPlotsFacet <- ggplot(sigPhageNormalizedAbdDFModified,
                                aes_string(x = "Growth_Status_Prior",
                                           y = "Abundance")) +
  geom_boxplot(width = 0.5, outlier.shape = NA) +
  geom_jitter(alpha = 0.7, width = 0.15, size = 1.5) +
  scale_y_log10() +
  ylab("Normalized Abd. (log10)") +
  facet_wrap(~ corrected_TaxaName,
             labeller = labeller(corrected_TaxaName = label_wrap_gen(10)),
             nrow = 3, ncol = 6) +
  theme_bw() +
  theme(legend.position = "none",
        axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
        axis.title.x = element_blank(),
        axis.text.y = element_text(size = 10),
        axis.title = element_text(size = 10),
        strip.text = element_text(size = 8))
groundTruthPlotsFacet
```

```{r save-phage-ground-truth, eval=FALSE}
tiff("../figures/FigureS1.tiff", 
     units = "in", width = 7.5, height = 7, res = 300)
groundTruthPlotsFacet
dev.off()
```

## Extract Normalized Abundances for Significant Phage from DESeq Results

For each significant phage detected by DESeq, extract the abundance values from psViralNormalizedMelt.

```{r significantPhageAbundanceDF}
significantPhageASVs <- pull(phageSigASVDFModified, "OTU")
significantPhageAbundanceDF <- filter(psViralNormalizedMelt,
                                      ASV %in% significantPhageASVs)

saveRDS(significantPhageAbundanceDF, "../data/RDataObjects/significantPhageAbundanceDF.RDS")
```

```{r save-image}
save.image("../data/RDataObjects/EE_Phage_Analysis_and_Figures.RData")
```

### Session Info

```{r session-info}
writeLines(capture.output(sessionInfo()), 
           "EE_Virome_Phage_Analysis_and_Figures_session_info.txt")
Sys.Date()
getwd()
sessionInfo()
```

