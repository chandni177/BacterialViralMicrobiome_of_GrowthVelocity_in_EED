---
title: "Environmental Enteropathy: Viral Richness Over Time"
author: "Rachel Rodgers"
date: "July 30, 2019"
output: html_document
---

```{r initiate-environment, include=FALSE}
# Global knitr option
knitr::opts_chunk$set(warning=FALSE,
                      message=FALSE)

# Load libraries
library("phyloseq")
library("RColorBrewer")
library("vegan")
library("gridExtra")
library("knitr")
library("plotly")
library("ggpubr")
library("data.table")
library("microbiome")
library("DESeq2")
library("ggrepel")
library("pheatmap")
library("FSA")
library("gmodels")
library("tidyverse")

source("./shared_R_scripts/Helper_Functions.R")
```

In this markdown I will be combining the selected phage from MEGAN and the eukaryotic virus data (at family level) from VS for all samples (healthy and EE) into one object in order to plot richness of viral taxa by age for figure 1.

First I will load the phage physeq object (physeqSubsetFinal).

```{r phage-data}
load("../data/RDataObjects/EE_Virome_Preprocessing.RData")
physeqSubsetFinal # 1021 x 147
head(sample_names(physeqSubsetFinal)) # contins all samples (healthy + EE)
```

Now I will load in the eukaryotic viral data for all samples.

```{r physeqEukFamily}
physeqEukFamily <- readRDS("../data/physeqObjects/physeqEukFamily.RDS")
physeqEukFamily # 35 x 131
head(sample_names(physeqEukFamily)) # contains all samples (healthy + EE)
```

All we need is an OTU table in order to calculate richness.

```{r}
# extract and transform the otu tables for phage and eukaryotes
phageOTUTable <- as(otu_table(physeqSubsetFinal), "matrix") %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "long_sample_name")
dim(phageOTUTable) # 147 samples

eukOTUTable <- as(otu_table(physeqEukFamily), "matrix") %>% 
  t() %>% 
  as.data.frame() %>% 
  rownames_to_column(var = "short_sample_name")
dim(eukOTUTable) # 131 samples

# make a long-to-short sample name LUT
allSampleData <- sampleDataFull %>% 
  rownames_to_column(var = "long_sample_name")
sampleNameLUT <- as.character(allSampleData$sample_name)
names(sampleNameLUT) <- as.character(allSampleData$long_sample_name)
head(sampleNameLUT)

# add short sample name column to phageOTUTable
phageOTUTable <- phageOTUTable %>% 
  mutate("short_sample_name" = sampleNameLUT[long_sample_name]) %>% 
  select(short_sample_name, everything())

# merge phage and eukaryotic otu tables on the short sample name
fullViralOTUTable <- merge(phageOTUTable, eukOTUTable,
                           by = "short_sample_name",
                           all = TRUE)

# Fill in missing short_sample_name by modifying the long_sample_name column
fullViralOTUTable <- fullViralOTUTable %>% 
  mutate(short_sample_name = ifelse(is.na(short_sample_name),
                                    yes = str_extract(string = long_sample_name, 
                                                      pattern = "Manary.*"),
                                    no = short_sample_name))

# set any NAs in the table to 0
fullViralOTUTable[is.na(fullViralOTUTable)] <- 0

# change the table back into otu class
viralOTUTable <- fullViralOTUTable %>% 
  select(-long_sample_name) %>% 
  column_to_rownames(var = "short_sample_name") %>% 
  as.matrix() %>% 
  t()

viralOTUTableFinal <- otu_table(viralOTUTable, taxa_are_rows = TRUE)

# Calculate richness on this table
totalViralRichness <- estimate_richness(viralOTUTableFinal,
                                        measures = "Observed")
row.names(totalViralRichness) <- c(gsub("\\.", "-", rownames(totalViralRichness)))
totalViralRichness <- rownames_to_column(totalViralRichness, var = "sample_name")

# merge with sample data, expect 159 rows
sampleDataFull$sample_name <- as.character(sampleDataFull$sample_name)
sampleDataFullModified <- sampleDataFull %>% 
  rownames_to_column(var = "long_sample_name") %>% 
  mutate("sample_name" = ifelse(is.na(sample_name),
                                yes = str_extract(string = long_sample_name,
                                                  pattern = "Manary.*"),
                                no = sample_name))

fullViralSampleData <- merge(sampleDataFull, totalViralRichness,
                             by = "sample_name", all = TRUE)

# remove samples having no age_months
fullViralSampleData <- filter(fullViralSampleData, !(is.na(age_months)))

saveRDS(fullViralSampleData, file = "../data/RDataObjects/fullViralSampleData.RDS")
```

```{r regression-viral-richness-by-age}
viralRichRegression <- lm(Observed ~ age_months, data = fullViralSampleData)
summary(viralRichRegression)

viralRichPlot <- ggscatter(fullViralSampleData, x = "age_months", y = "Observed", 
                           add = "reg.line",
                           conf.int = TRUE) +
  stat_smooth(method = lm) +
  geom_point(size = 2) +
  ggtitle("Viral Richness with Age") +
  labs(y = "Richness", x = "Age in months") +
  theme(plot.title = element_text(hjust = 0.5))

viralRichPlot
```

Save fullViralSampleData for use in EE_Bacterial_Figures.Rmd (for figure panel 1).

```{r save-fullViralSampleData}
saveRDS(fullViralSampleData, "../data/RDataObjects/fullViralSampleData.RDS")
```

### Session Info

```{r session-info}
writeLines(capture.output(sessionInfo()), 
           "EE_Viral_Richness_Over_Time_session_info.txt")
Sys.Date()
getwd()
sessionInfo()
```
