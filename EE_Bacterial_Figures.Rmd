---
title: "Environmental Enteropathy: Bacterial Figures"
author: "Chandni Desai & Rachel Rodgers"
date: "July 30, 2019"
output: html_document
---

# Introduction

Code for generation of basic bacterial figures.

```{r load-data, message=FALSE}
load("../data/RDataObjects/Jul30_BacteriaData.RData")

# Load libraries
library("phyloseq")
library("RColorBrewer")
library("vegan")
library("gridExtra")
library("knitr")
library("plotly")
library("ggpubr")
library("data.table")
library("microbiome")
library("DESeq2")
library("ggrepel")
library("pheatmap")
library("FSA")
library("gmodels")
library("multcomp")
library("tidyverse")

theme_set(theme_bw(base_size = 14))
```

# FIGURE 1: COHORT

## Figure 1 Panel A: Sampling timeline

```{r figure1pA-sampling-timeline}
# Add color to points based on disease status and line segements based on growth status (prior).
# Remove samples not having an EE status.
# Add growth status for patient 3 which was previously missing from metadata.
deltaHAZValues <- read.delim("../documents/analyzedSamplesWithDeltas.txt",
                             check.names = FALSE) # 84

patient3GrowthStatus <- deltaHAZValues %>% 
  filter(Subject_ID == 3) %>% 
  select(Manary_Barcode, Growth_Status_Prior) %>% 
  mutate_if(is.factor, as.character) %>% 
  deframe()

sd <- as(sd, "data.frame") %>% droplevels()

sd <- sd %>% 
  filter(!(is.na(EE_status_based_on_percL))) %>% 
  droplevels()

sd$X.SampleID <- as.character(sd$X.SampleID)
sd$Growth_Status_Prior <- as.character(sd$Growth_Status_Prior)

sd <- sd %>% 
  mutate(Growth_Status_Prior = ifelse(X.SampleID %in% names(patient3GrowthStatus),
                                      yes = patient3GrowthStatus[X.SampleID],
                                      no = Growth_Status_Prior))

sd$Growth_Status_Prior <- as.factor(sd$Growth_Status_Prior)
levels(sd$Growth_Status_Prior)

sd$Growth_Status_Prior <- factor(sd$Growth_Status_Prior,
                                 labels = c("Adequate", "none",  "Moderate", 
                                            "none", "Poor"))
sd$Growth_Status_Prior <- factor(sd$Growth_Status_Prior, 
                                 levels = c("Adequate", "Moderate", "Poor", "none"))

plot1_A <- ggplot(sd,
                  aes(x = age_months,
                      y = reorder(factor(patient_ID), age_months),
                      shape = EE_status_based_on_percL)) + 
  geom_line(inherit.aes = FALSE, 
            size = 1,
            aes(x = age_months,
                y = reorder(factor(patient_ID), age_months),
                group = patient_ID,
                color = Growth_Status_Prior)) +
  scale_color_manual(breaks = c("Adequate", "Moderate", "Poor"),
                                values = c("Red", "Blue", "Green", "Black")) +
  guides(shape = guide_legend(title = "EE Status"),
         color = guide_legend(title = "Growth Status")) +
  geom_point(size = 2.5) + 
  labs(y = "Patient ID", x = "Age in months") +
  theme(axis.title = element_text(size = 10),
        axis.text.x = element_text(size = 10),
        axis.text.y = element_text(size = 9))

set.seed(2137091)
plot1_A
```

## Figure 2 Panel B: perc L

```{r figure1pB-percent-L}
# points should be shaped to reflect their EE status
plot1_B <- ggplot(sd, aes(x = "", y = perc_L)) +
  geom_boxplot(outlier.shape = NA) +
  #geom_point(aes(shape = EE_status_based_on_percL)) +
  geom_jitter(alpha = 0.7, width = 0.15, size = 2.5,
              aes(shape = EE_status_based_on_percL)) +
  geom_hline(yintercept = 0.2, alpha = 0.5, linetype = 2) +
  geom_hline(yintercept = 0.45 ,alpha = 0.5, linetype = 2) +
  labs(y = "%L", x = "") +
  #guides(shape = guide_legend(title = "EE Status")) +
  theme(axis.title = element_text(size = 10),
        axis.text = element_text(size = 10),
        legend.position = "none")
set.seed(2137091)
plot1_B
```

## Figure 3 Panel C: delta HAZ

```{r figure1pC-delta-HAZ}
## Use data from file: plottingdeltaHAZ_dataforfigure.txt (delta HAZ for all samples)
deltaHAZ <- read.table(file = "../documents/plottingdeltaHAZ_dataforfigure.txt", 
                       header = TRUE)

# add Growth_Status_Prior
deltaHAZ <- deltaHAZ %>% 
  mutate("Growth_Status" = case_when(deltaHAZ > 0 ~ "Adequate",
                                     deltaHAZ >= -0.30 & deltaHAZ <= 0 ~ "Moderate",
                                     deltaHAZ < -0.30 ~ "Poor"))

deltaHAZ$Growth_Status <- factor(deltaHAZ$Growth_Status,
                                 levels = c("Adequate", "Moderate", "Poor"))

plot1_C <- ggplot(deltaHAZ, 
                  aes(x = "", y = deltaHAZ)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(alpha = 0.7, width = 0.15, size = 2.5,
              aes(color = Growth_Status)) +
  scale_color_manual(values = c("Red", "Blue", "Green")) +
  geom_hline(yintercept = -0.3, alpha = 0.5, linetype = 2) +
  geom_hline(yintercept = 0,alpha = 0.5, linetype = 2) +
  labs(y = expression(Delta ~ HAZ), x = "") +
  #guides(color = guide_legend(title = "Growth Status")) +
  theme(axis.title = element_text(size = 10),
        axis.text = element_text(size = 10),
        legend.position = "none")
set.seed(2137091)
plot1_C
```

## ARRANGE Figure 1

```{r figure1-panel-arrange, fig.width=11, fig.height=8.5}
figure1 <- ggarrange(plot1_A, 
                     ggarrange(plot1_B, plot1_C,
                               labels = c("B", "C"),
                               heights = c(1, 1),
                               nrow = 2), 
                     ncol=2, 
                     labels = "A", 
                     widths = c(1,1),
                     common.legend = TRUE, legend = "bottom")
figure1
```

```{r figure-1-tiff, eval=FALSE}
tiff("../figures/Figure1.tiff",
     units = "in", width = 7.5, height = 6, res = 300)
figure1
dev.off()

pdf("../figures/Figure1.pdf",
    height = 6, width = 7.5)
figure1
dev.off()
```

# FIGURE 2: Bacterial Community Composition, Richness Regression, Alpha & Beta Diversity

## Figure 2 Panel A : Bacterial Community Composition

```{r figure2pA-bacterial-community-composition}
plot2_A <- ggplot(ps2.goodmoderatepoorgrowth.priorsamplesonly.phylum, 
                  aes(x = sample_name, 
                      y = Abundance, 
                      fill = Phylum)) + 
  geom_bar(stat = "identity", width = 1, position = "fill") +
  labs(y="Relative Abundance", x="") +
  facet_wrap(~Growth_Status_Prior, scales = "free_x") +
  theme(axis.text.x = element_blank(),
        axis.title.x = element_blank(),
        axis.title.y = element_text(size = 12),
        strip.text = element_text(size = 10),
        legend.position = "bottom",
        legend.title = element_blank(),
        legend.text = element_text(size = 10),
        legend.box.margin = margin(-10, -10, -10, -10),
        legend.key.size = unit(0.5, "cm")) + 
  scale_fill_brewer(palette="Set1")
plot2_A
```

## Fig 2 Panel B: Richness Regression with Age

```{r figure1pB-bacterial-richness-with-age}
## Use phyloseq object : ps2 (All Samples)

# Remove healthy samples from the data before plotting
sampleDataPS2 <- as(sample_data(ps2), "data.frame")

ps2EESamples <- subset_samples(ps2,
                               EE_status_based_on_percL != "No" &
                                 !(is.na(EE_status_based_on_percL))) # 2432 x 126

alphaDivPS2EESamples <- estimate_richness(ps2EESamples, measures = c("Observed", "Shannon"))

# merge with sample data
alphaDivPS2EESamples <- merge(sampleDataPS2, alphaDivPS2EESamples, 
                              by ="row.names", all = FALSE)

## Calculate regression coefficient
regression <- lm(Observed ~ age_months, data = alphaDivPS2EESamples)
summary(regression)

plot2_B <- ggplot(alphaDivPS2EESamples, aes(x = age_months, y = Observed)) + 
  geom_point(size = 1.5) + 
  stat_smooth(method = lm) +
  labs(y="Bacterial Richness", x = "Age in months") +
  annotate("text", x = 20, y = 325, 
           label = "paste(italic(R) ^ 2, \" = 0.346\")", parse = TRUE) +
  theme(axis.title = element_text(size = 10),
        axis.text = element_text(size = 10))
set.seed(2137091)
plot2_B
```

## Figure 2 Panel C: Richness Boxplots by Growth Status

```{r figure2pC-bacterial-richness}
plot2_C <- ggplot(ps2.goodmoderatepoorgrowth.priorsamplesonly.bacteria.rich, 
                  aes(x = Growth_Status_Prior, y = Observed)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(alpha = 0.7, width = 0.15, size = 1.5) +
  ylab("Richness") +
  stat_compare_means(label = "p.format", method = "kruskal.test", 
                     hide.ns = TRUE, 
                     label.x.npc = 0,
                     label.y.npc = 0.9,
                     size = 3.5) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.y = element_text(size = 10))
set.seed(2908795)
plot2_C
```

## Figure 2 Panel D: Shannon Diversity Boxplots by Growth Status

```{r figure2pD-bacterial-shannon-diversity}
plot2_D <- ggplot(ps2.goodmoderatepoorgrowth.priorsamplesonly.bacteria.rich, 
                  aes(x = Growth_Status_Prior, y = Shannon)) +
  geom_boxplot(outlier.shape = NA) +
  geom_jitter(alpha = 0.7, width = 0.15, size = 1.5) +
  ylab("Shannon Diversity") +
  stat_compare_means(label = "p.format", method = "kruskal.test", 
                     hide.ns = TRUE, 
                     label.x.npc = 0.0,
                     label.y.npc = 0.9,
                     size = 3.5) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(angle = 45, hjust = 1),
        axis.title.y = element_text(size = 10))
set.seed(2908795)
plot2_D
```

## Figure 2 Panel E: weighted Unifrac PCoA

```{r figure2p#-bacterial-pcoa-wUniFrac}
# Extract eigenvalues from ordination object for easier customization of ggplot
eigenValues <- ord.ps2.goodmoderatepoor.wuni.prior$values$Relative_eig

plot2_EDF <- plot_ordination(ps2.goodmoderatepoorgrowth.priorsamplesonly.bacteria,
                             ord.ps2.goodmoderatepoor.wuni.prior,
                             justDF = TRUE)

plot2_E <- ggplot(plot2_EDF,
                  aes_string(x = "Axis.1", y = "Axis.2",
                             color = "Growth_Status_Prior")) +
  xlab(paste0("PCoA 1 (", round(100*eigenValues[1], digits = 1), "%)")) +
  ylab(paste0("PCoA 2 (", round(100*eigenValues[2], digits = 1), "%)")) +
  geom_point(size=2, alpha = 0.7) +
  annotate("text", x = -0.08, y = 0.2, label = "p = 0.634", size = 3.5) +
  scale_color_manual(values = c("red", "blue", "green")) +
  theme(legend.position = "right",
        legend.title = element_blank(),
        legend.text = element_text(size = 10),
        legend.box.margin = margin(-10, -10, -10, -10),
        axis.title = element_text(size = 10))
plot2_E
```

## ARRANGE Figure 2

```{r figure2-panel-arrange, fig.width=11, fig.height=8.5}
fig2TopRow <- ggarrange(plot2_A, plot2_B, labels = c("A", "B"), ncol = 2)

fig2BottomRow <- ggarrange(plot2_C, plot2_D, plot2_E,
                           labels = c("C", "D", "E"), ncol = 3)

figure2 <- ggarrange(fig2TopRow, fig2BottomRow, nrow = 2)
figure2
```

```{r eval=FALSE}
figure2 <- ggarrange(plot2_1, 
                     ggarrange(plot2_2, 
                               plot2_3, 
                               plot2_4, 
                               labels = c("B", "C", "D"), 
                               ncol=3, 
                               widths=c(0.2, 0.2, 0.3)), 
                     nrow = 2, 
                     labels = c("A"),
                     heights = c(1.1, 0.6, 0.75))
figure2
```

```{r fig-2-tiff}
tiff("../figures/Figure2.tiff", 
     units = "in", width = 7.5, height = 7, res = 300)
figure2
dev.off()

pdf("../figures/Figure2.pdf",
    width = 7.5, height = 7)
figure2
dev.off()
```


## FIGURE 3:  Bacterial Differential Abundance

## Panel A: Differential Abundance Summary Plot with error bars

```{r figure3p1-bacterial-differential-abundance, fig.width=7.5, fig.height=5}
## Dataframe with significant taxa : significanttaxa_dataframe_goodbadpriorsamplesbacteria.annotated

significanttaxa_dataframe_goodbadpriorsamplesbacteria.annotated_withTaxaNames <-
  data.frame(significanttaxa_dataframe_goodbadpriorsamplesbacteria.annotated) %>%
  unite(TaxaName, c(Genus, Species), sep = "_", remove = FALSE)

## Calculating standard errors
significanttaxa_dataframe_goodbadpriorsamplesbacteria.annotated_withTaxaNames$stderror_lower <- significanttaxa_dataframe_goodbadpriorsamplesbacteria.annotated_withTaxaNames$log2FoldChange - significanttaxa_dataframe_goodbadpriorsamplesbacteria.annotated_withTaxaNames$lfcSE

significanttaxa_dataframe_goodbadpriorsamplesbacteria.annotated_withTaxaNames$stderror_upper <- significanttaxa_dataframe_goodbadpriorsamplesbacteria.annotated_withTaxaNames$log2FoldChange + significanttaxa_dataframe_goodbadpriorsamplesbacteria.annotated_withTaxaNames$lfcSE

plot3_1 <- ggplot(significanttaxa_dataframe_goodbadpriorsamplesbacteria.annotated_withTaxaNames,
                  aes(x=log2FoldChange, y=TaxaName)) +
  geom_point(size = 2) +
  geom_vline(xintercept = 0, alpha = 0.5, linetype = 2) +
  geom_errorbarh(aes(xmin = stderror_lower, 
                     xmax = stderror_upper, 
                     height=0.1)) +
  labs(x = "log2 Fold Change", y = "") +
  theme(plot.subtitle = element_text(hjust = 0.5, size = 10),
        axis.title.x = element_text(size = 10),
        axis.text.y = element_text(size = 10)) +
  scale_y_discrete(limits = rev(unique(sort(significanttaxa_dataframe_goodbadpriorsamplesbacteria.annotated_withTaxaNames$TaxaName))))
plot3_1
```

```{r calculate-normalized-abundances-for-bacteria}
#ps2.goodmoderatepoorgrowth.priorsamplesonly.bacteria

# Convert modified object to deseq object to do the DESeq normalization
deseqPhyseq2 <- phyloseq_to_deseq2(ps2.goodmoderatepoorgrowth.priorsamplesonly.bacteria, 
                                   ~ Growth_Status_Prior)
# Function to calculate geometric means prior to estimateSizeFactiors()
gm_mean <- function(x) {
  exp(sum(log(x[x > 0]), na.rm = TRUE) / length(x))
}

geoMeansViralFinal <- apply(counts(deseqPhyseq2), 1, gm_mean)

deseqPhyseq2 <- estimateSizeFactors(deseqPhyseq2, geoMeans = geoMeansViralFinal)

set.seed(27031541)
deseqPhyseq2 <- DESeq(deseqPhyseq2, fitType = "local", test = "Wald")

# replace the counts
replace_counts = function(physeq, dds) {
  dds_counts = counts(dds, normalized = TRUE)
  if (!identical(taxa_names(physeq), rownames(dds_counts))) {
    stop("OTU ids don't match")
  }
  otu_table(physeq) = otu_table(dds_counts, taxa_are_rows = TRUE)
  return(physeq)
}

physeq2BacteriaNormalized <- replace_counts(physeq = ps2.goodmoderatepoorgrowth.priorsamplesonly.bacteria,
                                            dds = deseqPhyseq2)

bacteriaNormalizedMelt <- psmelt(physeq2BacteriaNormalized)

setnames(bacteriaNormalizedMelt, old = "OTU", new = "ASV")

saveRDS(bacteriaNormalizedMelt, 
        "../data/RDataObjects/bacteriaNormalizedMelt.RDS")
```


## Part 2 : Ground Truth Plots of all significantly differentially abundant taxa

There may be a problem with the incorrect taxa getting pulled?

```{r figure3p2-ground-truth-plots, fig.width=7.5, fig.height=5}
#Normalized Abundance of Bacterial Taxa assoc with Growth Velocity prior to growth period

# Add taxa name
ASV_TaxaNames <- significanttaxa_dataframe_goodbadpriorsamplesbacteria.annotated_withTaxaNames %>%
  dplyr::select(ASV,TaxaName)

abundancedataframe.rlog.pregrowth_withTaxaNames <- merge(bacteriaNormalizedMelt,
                                                         #abundancedataframe.rlog.pregrowth,
                                                         ASV_TaxaNames, 
                                                         by="ASV")

plot3_2DF <- subset(abundancedataframe.rlog.pregrowth_withTaxaNames,
                    Growth_Status_Prior %in% c("Adequate","Moderate", "Poor"))

plot3_2DF <- mutate(plot3_2DF,
                    "correctedName" = str_replace_all(string = TaxaName,
                                                      pattern = "_",
                                                      replacement = " "))

# drop the moderate samples
plot3_2DF_NoModerate <- plot3_2DF %>% 
  filter(Growth_Status_Prior != "Moderate") %>% 
  droplevels()

plot3_2 <- ggplot(plot3_2DF_NoModerate, 
                  aes(y = Abundance, 
                      x = Growth_Status_Prior)) +
  geom_boxplot(width = 0.5,  
               outlier.shape = NA) +
  geom_jitter(alpha = 0.7, width = 0.15) +
  scale_y_log10() +
  ylab("Normalized Abd. (log10)") +
  theme(legend.position = "none",
          axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
          axis.title.x = element_blank(),
          axis.text.y = element_text(size = 10),
          axis.title = element_text(size = 10),
          strip.text = element_text(size = 8)) +
  facet_wrap(~ correctedName,
             labeller = labeller(correctedName = label_wrap_gen(20)),
             nrow = 3)
plot3_2
```

Plot DESeq2 ground truth plots for adequate and poor samples, faceted by breast feeding status (yes/no per taxon).

```{r filter-bacterial-normalized-abd-df, eval=FALSE}
# from plot3_2DF, filter just the adequte and poor samples
# re-plor the normalized abundances, faceted by breast feeding status
bactNlAbdFiltDF <- plot3_2DF %>% 
  filter(Growth_Status_Prior %in% c("Adequate", "Poor")) %>% 
  droplevels()

# check there's still 9 ASVs
length(unique(bactNlAbdFiltDF$ASV))

# change bf_at_sampling levels so they're more understandable when plotted
levels(bactNlAbdFiltDF$bf_at_sampling)
bactNlAbdFiltDF$bf_at_sampling <- factor(bactNlAbdFiltDF$bf_at_sampling,
                                         labels = c("Not Breastfed",
                                                    "Breastfed"))
```

```{r corrected-plot-3-2, fig.width=11, fig.height=8.5, eval=FALSE}
plot3_2_corrected <- ggplot(bactNlAbdFiltDF,
                            aes(y = Abundance, x = bf_at_sampling)) +
  geom_boxplot(width = 0.5, outlier.shape = NA) +
  geom_jitter(alpha = 0.7, width = 0.15, size = 2) +
  scale_y_log10() +
  ylab("Normalized Abd. (log10)") +
  facet_wrap( ~ correctedName + Growth_Status_Prior,
              nrow = 3,
              labeller = labeller(correctedName = label_wrap_gen(20))) +
  theme(legend.position = "none",
          axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
          axis.title.x = element_blank(),
          axis.text.y = element_text(size = 10),
          axis.title = element_text(size = 10),
          strip.text = element_text(size = 8))
plot3_2_corrected
```

For each differentially abundant bacteria, we want to know what percent of samples in the not breastfed versus breastfed category are positive for the presence of that taxo, within growth category, by taxon.

```{r percent-samples-positive-for-taxa, eval=FALSE}
sigBactAbdTable <- bactNlAbdFiltDF %>% 
  dplyr::select(correctedName, Sample, Growth_Status_Prior, bf_at_sampling, Abundance) %>% 
  mutate("Present" = ifelse(Abundance > 0, yes = TRUE, no = FALSE))

# how many total breastfed vs non-breastfed samples are there?
samplesByBreastfeeding <- bactNlAbdFiltDF %>% 
  dplyr::select(sample_name, bf_at_sampling) %>% 
  unique()
table(samplesByBreastfeeding$bf_at_sampling) # 34 not breastfed, 10 bf

# double check this looks correct
sigBactAbdTable %>% 
  group_by(correctedName, bf_at_sampling) %>% 
  summarize("total_samples" = n())

sigBactSummaryTable <- sigBactAbdTable %>% 
  group_by(correctedName, bf_at_sampling, Growth_Status_Prior) %>% 
  summarize("total_samples" = n(), "total_true" = sum(Present)) %>% 
  mutate("percent_positive_for_taxon" = (total_true/total_samples) * 100)

sigBactSummaryTableFinal <- arrange(sigBactSummaryTable,
                                    correctedName, Growth_Status_Prior,
                                    bf_at_sampling)
```

```{r save-summary-table, eval=FALSE}
write.table(sigBactSummaryTableFinal, "../analyses/sigBactSummaryTableFinal.txt",
            quote = FALSE, sep = "\t", row.names = FALSE)
```

Fisher's exact testing on Bifidobacterium NA and Megasphaera NA.

```{r fishers-bifido, eval=FALSE}
# Breastfed samples
bifidoBreastfed <- bactNlAbdFiltDF %>% 
  filter(correctedName == "Bifidobacterium NA",
         Growth_Status_Prior %in% c("Adequate", "Poor"),
         bf_at_sampling == "Breastfed") %>% 
  droplevels() %>% 
  mutate("PA" = ifelse(Abundance > 0, 
                       yes = "Present", no = "Absent")) %>% 
  dplyr::select(Growth_Status_Prior, PA) %>% 
  table() %>% 
  CrossTable(propr.r = FALSE, prop.c = FALSE, prop.t = FALSE, prop.chisq = FALSE,
             fisher = TRUE)

# Not Breastfed samples
bifidoNotBreastfed <- bactNlAbdFiltDF %>% 
  filter(correctedName == "Bifidobacterium NA",
         Growth_Status_Prior %in% c("Adequate", "Poor"),
         bf_at_sampling == "Not Breastfed") %>% 
  droplevels() %>% 
  mutate("PA" = ifelse(Abundance > 0, 
                       yes = "Present", no = "Absent")) %>% 
  dplyr::select(Growth_Status_Prior, PA) %>% 
  table() %>% 
  CrossTable(propr.r = FALSE, prop.c = FALSE, prop.t = FALSE, prop.chisq = FALSE,
             fisher = TRUE)
```

```{r fishers-megasphaera, eval=FALSE}
# Breastfed samples
megaBreastfed <- bactNlAbdFiltDF %>% 
  filter(correctedName == "Megasphaera NA",
         Growth_Status_Prior %in% c("Adequate", "Poor"),
         bf_at_sampling == "Breastfed") %>% 
  droplevels() %>% 
  mutate("PA" = ifelse(Abundance > 0, 
                       yes = "Present", no = "Absent")) %>% 
  dplyr::select(Growth_Status_Prior, PA) %>% 
  table() %>% 
  CrossTable(propr.r = FALSE, prop.c = FALSE, prop.t = FALSE, prop.chisq = FALSE,
             fisher = TRUE)

# Not Breastfed samples
megaNotBreastfed <- bactNlAbdFiltDF %>% 
  filter(correctedName == "Megasphaera NA",
         Growth_Status_Prior %in% c("Adequate", "Poor"),
         bf_at_sampling == "Not Breastfed") %>% 
  droplevels() %>% 
  mutate("PA" = ifelse(Abundance > 0, 
                       yes = "Present", no = "Absent")) %>% 
  dplyr::select(Growth_Status_Prior, PA) %>% 
  table() %>% 
  CrossTable(propr.r = FALSE, prop.c = FALSE, prop.t = FALSE, prop.chisq = FALSE,
             fisher = TRUE)
```

```{r, eval=FALSE}
# do for all bacteria in the deseq results

generaToPlot <- ASV_TaxaNames$ASV
names(generaToPlot) <- ASV_TaxaNames$TaxaName

PlotGroundTruthByBF <- function(genusToPlot) {
  currentASV <- genusToPlot[[]]
}

subsetDFList <- vector(mode = "list", length = length(generaToPlot))

for (i in 1:length(generaToPlot)) {
  currentASV <- generaToPlot[[i]]
  currentName <- names(generaToPlot)[i]
  subsetDF <- plot3_2DF %>% 
    filter(ASV == currentASV & Growth_Status_Prior != "Moderate")
  subsetDFList[[i]] <- subsetDF
  names(subsetDFList)[i] <- currentName
}

GroundTruthByBF <- function(currentDF, currentTitle) {
  ggplot(currentDF, aes_string(y = "Abundance", x = "bf_at_sampling")) +
    geom_boxplot(width = 0.5, outlier.shape = NA) +
    geom_jitter(aes(size = baseMean), alpha = 0.7, width = 0.15) +
    scale_y_log10() +
    ylab("Normalized Abd. (log10)") +
    ggtitle(currentTitle) +
    theme(legend.position = "none",
          axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
          axis.title.x = element_blank(),
          axis.text.y = element_text(size = 10),
          axis.title = element_text(size = 10),
          strip.text = element_text(size = 8),
          plot.title = element_text(hjust = 0.5)) +
  facet_wrap(~Growth_Status_Prior)
}

for (i in 1:length(subsetDFList)) {
  currentDF <- subsetDFList[[i]]
  currentTitle <- names(subsetDFList)[i]
  plot(GroundTruthByBF(currentDF, currentTitle))
}
```

```{r, eval=FALSE}
plot3_2 <- ggplot(subset(plot3_2DF, Genus == "Megasphaera" &
                           Growth_Status_Prior != "Moderate"), 
                  aes(y = Abundance, 
                      x = bf_at_sampling)) +
  geom_boxplot(width = 0.5,  
               outlier.shape = NA) +
  geom_jitter(aes(size = baseMean), alpha = 0.7, 
              width = 0.15) +
  scale_y_log10() +
  ylab("Normalized Abd. (log10)") +
  theme(legend.position = "none",
          axis.text.x = element_text(angle = 45, hjust = 1, size = 10),
          axis.title.x = element_blank(),
          axis.text.y = element_text(size = 10),
          axis.title = element_text(size = 10),
          strip.text = element_text(size = 8)) +
  facet_wrap(~Growth_Status_Prior)
  #facet_wrap(~ correctedName,
             #labeller = labeller(correctedName = label_wrap_gen(20)),
             #nrow = 3)
plot3_2
```

Volcano plot of significant taxa

```{r, fig.width=11, fig.height=8.5}
sigTaxaGoodPoor <- significanttaxa_dataframe_goodbadpriorsamplesbacteria.annotated_withTaxaNames 

sigBacteriaVolcano <- ggplot(sigTaxaGoodPoor,
                             aes(x = log2FoldChange,
                                 y = -log10(padj))) +
  geom_point(aes(color = TaxaName, size = baseMean)) +
  geom_vline(xintercept = 0, lty = 2) +
  geom_hline(yintercept = -log10(0.05)) +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5),
          axis.text.x = element_text(angle = -90, hjust = 0, vjust = 0.5),
          axis.title = element_text(size = 12),
          axis.text = element_text(size = 12),
          legend.text = element_text(size = 12))

sigBacteriaVolcano

ggplotly(sigBacteriaVolcano)
```




## ARRANGE Panel Figure 3

```{r figure3-panel-arrange, fig.width=7, fig.height=7}
figure3 <- ggarrange(plot3_1, plot3_2,
                     labels = c("A", "B"), 
                     nrow = 2,
                     heights = c(1,2))
figure3
```

```{r fig-3-tiff, eval=FALSE}
tiff("../figures/Figure3.tiff",
     units = "in", width = 7, height = 7, res = 300)
figure3
dev.off()

pdf("../figures/Figure3.pdf", height = 7, width = 7)
figure3
dev.off()
```

## FIGURE 7: BACTERIA-PHAGE ASSOCIATIONS/RELATIONSHIPS


## Part 1 : Relationship between Bacteria and Phage Richness 

```{r figure7p1}
plot7_1 <- ggplot(bacteria_phage_richnessdiversity, 
                  aes(Bacterial_Richness,y=Phage_Richness, color=Growth_Status_Prior)) +
  geom_point(aes(color=Growth_Status_Prior)) +
  stat_smooth(method = "lm", se=T) +
  labs(y="Phage Richness", x="Bacterial Richness",  color="Growth Velocity") +
  theme(axis.title = element_text(size = 12),
        axis.text = element_text(size = 10),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 10),
        #panel.grid.minor = element_blank(),
        panel.grid.major = element_blank())

plot7_1
```

## Part 2 : Relationship between Bacteria and Phage Shannon Diversity

```{r figure2p2}
plot7_2 <- ggplot(bacteria_phage_richnessdiversity,
                  aes(Bacterial_ShannonDiversity,
                      y=Phage_ShannonDiversity,
                      color=Growth_Status_Prior)) +
  geom_point(aes(color=Growth_Status_Prior)) +
  stat_smooth(method = "lm", se=T) +
  labs(y="Phage Shannon Diversity", 
       x="Bacterial Shannon Diversity", 
       color="Growth Velocity") +
  theme(axis.title = element_text(size = 12),
        axis.text = element_text(size = 10),
        legend.title = element_text(size = 12),
        legend.text = element_text(size = 10),
        #panel.grid.minor = element_blank(),
        panel.grid.major = element_blank())
plot7_2
```

## ARRANGE Panel Figure 7

```{r figure7-panel-arrange, fig.width=7.5, fig.height=6}
figure7 <- ggarrange(plot7_1, plot7_2, nrow = 2,
                     labels = c("A", "B"))
figure7
```

## LM for Richness & Diversity by Growth Velocity Groups

```{r lm-richness}
growth_categories <- c("Adequate", "Moderate", "Poor")

## test ##
richnessDF <- bacteria_phage_richnessdiversity %>% 
  filter(Growth_Status_Prior == "Adequate")

lm_richness_adequate <- lm(Phage_Richness ~ Bacterial_Richness,
                           data = richnessDF)

# get adj r2
summary(lm_richness_adequate)$adj.r.squared

K <- diag(2)
lm_richness <- glht(lm_richness_adequate, linfct = K)
glsum <- summary(lm_richness)
summary(lm_richness)$test$pvalues
```

```{r figure-7-tiff, eval=FALSE}
tiff("../figures/Figure7.tiff",
     units = "in", width = 7, height = 6, res = 300)
figure7
dev.off()

pdf("../figures/Figure7.pdf", height = 6, width = 7)
figure7
dev.off()
```

## Supplemental Figure 2 : Correlation heatmap of significant bacteria vs phage abundances in samples from 2 growth velocities

```{r fig.width=7.5, fig.height=6, eval=FALSE}
CombinedHeatmaps <- readRDS("../data/RDataObjects/CombinedHeatmap.RDS")
oldHeatmapColNames <- colnames(CombinedHeatmaps)
newHeatmapColNames <- map_chr(.x = oldHeatmapColNames,
                              .f = ~ str_remove(., pattern = "\\.[:digit:]$"))
CombinedHeatmapsModified <- CombinedHeatmaps
colnames(CombinedHeatmapsModified) <- newHeatmapColNames

combinedHeatmapFigure <- pheatmap(CombinedHeatmapsModified,
                                  cluster_rows = FALSE,
                                  cluster_cols = FALSE)

```

```{r figure-S2-tiff, eval=FALSE}
tiff("../figures/FigureS2.tiff",
     units = "in", width = 7, height = 6, res = 300)
combinedHeatmapFigure
dev.off()
```

### Session Info

```{r session-info}
writeLines(capture.output(sessionInfo()), 
           "EE_Bacterial_Figures_session_info.txt")
Sys.Date()
getwd()
sessionInfo()
```



## Figure 5 B : Viral richness with age (move to phage figures)

```{r figure1p5-viral-richness-regression}
# import data from virus-side
fullViralSampleData <- readRDS("../data/RDataObjects/fullViralSampleData.RDS")
viralRichRegression <- lm(Observed ~ age_months, data = fullViralSampleData)
summary(viralRichRegression)
```

```{r figure1p5-viral-richness-with-age}
plot1_5 <- ggplot(fullViralSampleData, 
                  aes(x = age_months, y = Observed)) + 
  geom_point(size = 1.5) + 
  stat_smooth(method = lm) +
  labs(y="Viral Richness", x="Age in months") +
  annotate("text", x = 20, y = 600, label = "paste(italic(R) ^ 2, \" = 0.023\")", 
           parse = TRUE) +
  theme(axis.title = element_text(size = 10),
        axis.text = element_text(size = 10))
set.seed(2137091)
plot1_5
```